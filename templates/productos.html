<!-- productos.html -->
{% extends './layout.html' %}

{% block body %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card-holder">
                <div class="card-box bg-news">
                    <h3 class="title">Ingreso de nuevos productos</h3>
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                    <div class="container mt-3">
                        <!-- Botón para mostrar el formulario -->
                        <button id="mostrarFormularioBtn" class="btn btn-primary">Agregar Producto</button>
                    </div>
                    <!-- Contenedor del formulario -->
                    <div id="agregarProductoForm" style="display: none;">

                        <div class="cerrar-formulario" style="text-align: right;">
                            <button type="button" class="close" id="cerrarFormularioBtn" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form action="{{ url_for('add_productos') }}" method="post">
                            <div class="card-details">
                                <div class="form-group">
                                    <label for="referencia">Referencia</label>
                                    <div class="input-group">
                                        <input type="text" name="referencia" id="referencia" class="form-control" placeholder="Ingrese referencia del producto" required>
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="nombre">Nombre</label>
                                    <div class="input-group">
                                        <input type="text" name="nombre" id="nombre" class="form-control" placeholder="Ingrese nombre del producto" required>
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="descripcion">Descripción</label>
                                    <textarea name="descripcion" id="descripcion" class="form-control" placeholder="Ingrese descripción del producto" rows="4" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="cantidad">Cantidad</label>
                                    <div class="input-group">
                                        <input type="number" name="cantidad" id="cantidad" class="form-control" placeholder="Ingrese cantidad del producto" required>
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-box"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="precio">Precio</label>
                                    <div class="input-group">
                                        <input type="number" name="precio" id="precio" class="form-control" placeholder="Ingrese precio del producto" required>
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="medida_l">Medida Largo</label>
                                        <div class="input-group">
                                            <input type="text" name="medida_l" id="medida_l" class="form-control" placeholder="Ingrese largo" required>
                                            <div class="input-group-append">
                                                <span class="input-group-text"><i class="fas fa-ruler"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="medida_a">Medida Ancho</label>
                                        <div class="input-group">
                                            <input type="text" name="medida_a" id="medida_a" class="form-control" placeholder="Ingrese ancho" required>
                                            <div class="input-group-append">
                                                <span class="input-group-text"><i class="fas fa-ruler-horizontal"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="tipomedida">Tipo de Medida</label>
                                        <div class="input-group">
                                            <select name="tipomedida" id="tipomedida" class="form-control" required>
                                                <option value="" disabled selected>Tipo de medida</option>
                                                <option value="cm">Centímetros (cm)</option>
                                                <option value="m">Metros (m)</option>
                                                <option value="mm">Milímetros (mm)</option>
                                                <option value="in">Pulgadas (in)</option>
                                                <option value="ft">Pies (ft)</option>
                                            </select>
                                            <div class="input-group-append">
                                                <span class="input-group-text"><i class="fas fa-ruler-combined"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="categoria">Categoría</label>
                                    <div class="input-group">
                                        <select name="categoria" id="categoria" class="form-control" required>
                                            <option value="" disabled selected>Seleccione una categoría</option>
                                            {% for categoria in categorias %}
                                                <option value="{{ categoria[0] }}">{{ categoria[1] }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-tags"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="proveedor">Proveedor</label>
                                    <div class="input-group">
                                        <select name="proveedor" id="proveedor" class="form-control" required>
                                            <option value="" disabled selected>Seleccione un proveedor</option>
                                            {% for proveedor in proveedores %}
                                                <option value="{{ proveedor[0] }}">{{ proveedor[1] }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-truck"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">Agregar Producto</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="container mt-5">
    <h2>Tabla de Productos</h2>
    <div class="table-responsive">
        <table id="tablasJs" class="table table-striped table-bordered table-hover">
            <thead class="bg-green">
                <tr>
                    <th scope="col">Referencia</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Descripción</th>
                    <th scope="col">Cantidad</th>
                    <th scope="col">Precio</th>
                    <th scope="col">Medida Largo</th>
                    <th scope="col">Medida Ancho</th>
                    <th scope="col">Tipo de Medida</th>
                    <th scope="col">Categoría</th>
                    <th scope="col">Proveedor</th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                <tr>
                    <th scope="row">{{ producto[0] }}</th>
                    <td>{{ producto[1] }}</td>
                    <td>{{ producto[2] }}</td>
                    <td>{{ producto[3] }}</td>
                    <td>{{ producto[4] }}</td>
                    <td>{{ producto[5] }}</td>
                    <td>{{ producto[6] }}</td>
                    <td>{{ producto[7] }}</td>
                    <td>{{ producto[8] }}</td>
                    <td>{{ producto[9] }}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-success" data-toggle="modal"
                            data-target="#editarProductoModal{{ producto[0] }}">
                            <i class="fas fa-pencil-alt"></i> Editar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% for producto in productos %}
<!-- Ventana Modal para Editar Producto -->
<div class="modal fade" id="editarProductoModal{{ producto[0] }}" tabindex="-1" role="dialog" aria-labelledby="editarProductoModal{{ producto[0] }}Label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarProductoModal{{ producto[0] }}Label">Editar Producto</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('update_producto', referencia=producto[0]) }}" method="POST">
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" value="{{ producto[1] }}" required>
                    </div>
                    <div class="form-group">
                        <label for="descripcion">Descripción</label>
                        <input type="text" class="form-control" id="descripcion" name="descripcion" value="{{ producto[2] }}" required>
                    </div>
                    <div class="form-group">
                        <label for="cantidad">Cantidad</label>
                        <input type="number" class="form-control" id="cantidad" name="cantidad" value="{{ producto[3] }}" required>
                    </div>
                    <div class="form-group">
                        <label for="precio">Precio</label>
                        <input type="number" class="form-control" id="precio" name="precio" value="{{ producto[4] }}" required>
                    </div>
                    <div class="form-group">
                        <label for="medida_l">Medida Largo</label>
                        <input type="number" class="form-control" id="medida_l" name="medida_l" value="{{ producto[5] }}" required>
                    </div>
                    <div class="form-group">
                        <label for="medida_a">Medida Ancho</label>
                        <input type="number" class="form-control" id="medida_a" name="medida_a" value="{{ producto[6] }}" required>
                    </div>
                    <div class="form-group">
                        <label for="tipomedida">Tipo de Medida</label>
                        <select class="form-control" id="tipomedida" name="tipomedida" required>
                            <option value="" disabled>Seleccione el tipo de medida</option>
                            <option value="cm" {% if producto[7] == 'cm' %}selected{% endif %}>Centímetros (cm)</option>
                            <option value="m" {% if producto[7] == 'm' %}selected{% endif %}>Metros (m)</option>
                            <option value="mm" {% if producto[7] == 'mm' %}selected{% endif %}>Milímetros (mm)</option>
                            <option value="in" {% if producto[7] == 'in' %}selected{% endif %}>Pulgadas (in)</option>
                            <option value="ft" {% if producto[7] == 'ft' %}selected{% endif %}>Pies (ft)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoría</label>
                        <select class="form-control" id="categoria" name="categoria" required>
                            <option value="" disabled>Seleccione una categoría</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria[0] }}" {% if producto[8] == categoria[1] %}selected{% endif %}>{{ categoria[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="proveedor">Proveedor</label>
                        <select class="form-control" id="proveedor" name="proveedor" required>
                            <option value="" disabled>Seleccione un proveedor</option>
                            {% for proveedor in proveedores %}
                                <option value="{{ proveedor[0] }}" {% if producto[9] == proveedor[1] %}selected{% endif %}>{{ proveedor[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Actualizar Producto</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<style>
    /* Estilos para hacer la tabla más compacta */
    .dataTables_wrapper .dataTables_filter {
        float: right;
        text-align: right;
    }
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_info {
        float: left;
        text-align: left;
    }
    .dataTables_wrapper .dataTables_paginate {
        float: right;
        text-align: right;
    }

    /* Ajustar el ancho de la tabla */
    #productosTable {
        width: 100% !important;
        table-layout: auto; /* Ajusta el ancho de las columnas */
    }

    /* Ajustar el padding para hacer la tabla más compacta */
    table.dataTable thead th,
    table.dataTable tbody td {
        padding: 4px 6px;
    }
</style>
<script>
    // Validación para campos numéricos no negativos
    document.getElementById('cantidad').addEventListener('input', function() {
        if (this.value < 0) {
            this.setCustomValidity('La cantidad no puede ser negativa');
        } else {
            this.setCustomValidity('');
        }
    });

    document.getElementById('precio').addEventListener('input', function() {
        if (this.value < 0) {
            this.setCustomValidity('El precio no puede ser negativo');
        } else {
            this.setCustomValidity('');
        }
    });

    document.getElementById('medida_l').addEventListener('input', function() {
        if (this.value < 0) {
            this.setCustomValidity('La medida largo no puede ser negativa');
        } else {
            this.setCustomValidity('');
        }
    });

    document.getElementById('medida_a').addEventListener('input', function() {
        if (this.value < 0) {
            this.setCustomValidity('La medida ancho no puede ser negativa');
        } else {
            this.setCustomValidity('');
        }
    });

    // Validación para campo "nombre" que solo acepte letras
    document.getElementById('nombre').addEventListener('input', function() {
        if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(this.value)) {
            this.setCustomValidity('El nombre solo debe contener letras');
        } else {
            this.setCustomValidity('');
        }
    });

    // Mostrar mensajes de error debajo de los campos
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            if (!input.checkValidity()) {
                const errorMessage = input.validationMessage;
                const errorElement = document.createElement('div');
                errorElement.classList.add('invalid-feedback');
                errorElement.textContent = errorMessage;
                if (!input.nextElementSibling.classList.contains('invalid-feedback')) {
                    input.parentNode.insertBefore(errorElement, input.nextElementSibling);
                }
                event.preventDefault();
            }
        });
    });
</script>
  
{% endblock %}
